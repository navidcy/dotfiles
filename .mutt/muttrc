# IMAP: offlineimap
set folder = "~/Mail"
source ~/.mutt/mailboxes  # mailboxes generated by offlineimap
set spoolfile = "+riseup/INBOX"
set mbox_type=Maildir

# Send mail settings
folder-hook riseup 'set \
        from="Anders Damsgaard <andersd@riseup.net> "\
        realname="Anders Damsgaard"\
        record=+riseup/Sent\
        postponed=+riseup/Drafts\
        sendmail = "msmtp -a riseup"'

folder-hook geomail 'set \
        from="Anders Damsgaard <anders.damsgaard@geo.au.dk> "\
        realname="Anders Damsgaard"\
        record=+geomail/Sent\
        postponed=+geomail/Drafts\
        signature=~/.signature\
        sendmail = "msmtp -a geomail"'

folder-hook ucsd 'set \
        from="Anders Damsgaard <adamsgaard@ucsd.edu> "\
        realname="Anders Damsgaard"\
        record=+ucsd/Sent\ Items\
        postponed=+ucsd/Drafts\
        signature=~/.signature\
        sendmail = "msmtp -a ucsd"'

folder-hook gmail 'set \
        from="Anders Damsgaard <andersdc@gmail.com> "\
        realname="Anders Damsgaard"\
        record=+gmail/[Gmail].Sent\ Mail\
        postponed=+gmail/[Gmail].Drafts\
        sendmail = "msmtp -a gmail"'

# ignore own e-mail addresses from group-reply
alternates adamsgaard@ucsd.edu|adamsgaard@mail.ucsd.edu|andersd@risuep.net|andersdc@gmail.com|adc@geo.au.dk|anders.damsgaard@geo.au.dk

# Cache files
set header_cache=~/.mutt/cache/headers
set message_cachedir=~/.mutt/cache/bodies

# Custom certificates
set certificate_file=~/.mutt/certificates

# sort threads by date
set sort=threads
set sort_aux = reverse-last-date-received

set charset=utf-8
set config_charset=utf-8
set noallow_8bit
set ascii_chars=no    # set to yes if terminal cannot display thread symbols
set send_charset="utf-8"
set assumed_charset="iso-8859-1"
set meta_key=yes
set attribution="* %n <%a> [%{%Y-%m-%d %H:%M:%S %Z}]:\n"
set edit_headers      # edit the message headers.
set fast_reply=yes    # skip initial prompts when replying
set include=yes       # include original mail in reply
set editor="vim +8 -c 'set ft=mail noautoindent spell spelllang=en_us,da'"
set nomark_old        # Don't mark unread new msgs as old.
set nosmart_wrap      # Don't want smart wrapping.
set nomarkers         # Don't want any wrap markers.
set mime_forward      # Forward message as MIME attachments.
set pager_context=3   # Display 3 lines of context in pager.
set nostrict_threads  # Lets have some fuzzy threading.
set fcc_clear         # Keep fcc's clear of signatues and encryption.
set nopipe_decode     # Don't decode messages when piping.
set text_flowed       # label messages as format-flowed
set sleep_time=0      # speed up IMAP folders switch

set ispell="aspell -e -c"
set tilde            # Fill out messages with '~'.
set read_inc=100     # Read counter ticks every 100 msgs.
set write_inc=100    # Write counter ticks every 100 msgs.
set noconfirmappend  # Just append, don't hassle me.
set pager_stop=yes   # Stop at end of mail instead of displaying next mail

# What we consider to be a quote.
set quote_regexp="^( {0,4}[>|:#%]| {0,4}[a-z0-9]+[>|]+)+"
set to_chars=" +TCF "   # Drop the "L".

# Display download progress every 5K
set net_inc=5

# When viewing a message, show the pager in # lines above
set pager_index_lines=5

# Mail check interval
set timeout = 15
set mail_check = 5    # how often (in seconds) mutt should look for new mail (default = 5 sec)

set alias_file=~/.mutt/aliases  # Save aliases here
set sort_alias = alias  # sort alias list when displayed in mutt
set reverse_alias = yes # sort in reverse order
source ~/.mutt/aliases  # Load in my aliases.

source ~/.sec/gpg.rc   # Use GPG
source ~/.mutt/colors  # Define colours.
#source ~/.mutt/mutt-colors-solarized/mutt-colors-solarized-dark-16.muttrc

auto_view text/html
# HTML is the last option.
alternative_order text/plain text/enriched text/html

# attach multiple files from file browser with 't' (tag).  To attach tagged 
# files: ';<enter>'

# show email in browser
macro attach V "<pipe-entry>cat >~/.mutt_mail.html && open ~/.mutt_mail.html<enter>" "show attachment in browser"

# vi-like movement
bind attach,index gg first-entry
bind attach,index G last-entry
bind pager gg top
bind pager G bottom
bind attach,index,pager \CD next-page
bind attach,index,pager \CU previous-page

bind index,pager R  group-reply
bind index <tab>    sync-mailbox

macro index M "T~N<enter>;WNT~O<enter>;WO\CT~T<enter>" "Mark all messages as read"
macro index \ f "l~F<enter>" "Show only flagged messages"

# Macros to change between inboxes (e.g. SPACE 1), use noop editor to accept 
# IMAP folders with spaces
bind editor <space> noop
macro index \ 1 "<change-folder>=riseup/INBOX/<enter>" "Go to Riseup inbox"
macro index \ u "<change-folder>=riseup/Spam.unsure/<enter>" "Go to Riseup/Spam.unsure"
macro index \ a "<change-folder>=riseup/academic-alerts/<enter>" "Go to Riseup/academic-alerts"
macro index \ s "<change-folder>=riseup/Spam/<enter>" "Go to Riseup/Spam"
macro index \ ! "<change-folder>=riseup/Sent/<enter>" "Go to Riseup sent"
macro index \ 2 "<change-folder>=geomail/INBOX/<enter>" "Go to Geomail inbox"
macro index \ @ "<change-folder>=geomail/Sent/<enter>" "Go to Geomail sent"
macro index \ 3 "<change-folder>=ucsd/INBOX/<enter>" "Go to UCSD inbox"
macro index \ \# "<change-folder>=ucsd/Sent Items/<enter>" "Go to UCSD sent"
macro index \ 4 "<change-folder>=gmail/INBOX/<enter>" "Go to Gmail inbox"
macro index \ $ "<change-folder>=gmail/[Gmail].Sent\ Mail/<enter>" "Go to Gmail sent"
macro index \ c "<change-folder>=geomail/INBOX.cryolist/<enter>" "Go to cryolist"


# mutt-sidebar
set sidebar_visible = no
macro index \ S '<enter-command>toggle sidebar_visible<enter><refresh>'
macro pager \ S '<enter-command>toggle sidebar_visible<enter><redraw-screen>'
bind index,pager \CP sidebar-prev
bind index,pager \CN sidebar-next
bind index,pager \CO sidebar-open
#set sidebar_sort = yes  # fix order of sidebar entries

# abook address book
set query_command= "abook --mutt-query '%s'"
#macro index,pager a "<pipe-message>abook --add-email-quiet<return>" "add the 
#sender address to abook"
macro index,pager A "!$EDITOR ~/.mutt/aliases\n:source ~/.mutt/aliases\n" "Edit aliases file and reload it"
macro pager a "<create-alias>" "create an alias from the message sender"
macro index Y "<next-unread-mailbox>" "go to next mailbox with unread mails"

# Sync email
#macro index O "<shell-escape>offlineimap -u blinkenlights<enter>" "run 
#offlineimap to sync all mail"
#macro index o "<shell-escape>offlineimap -u blinkenlights -qf INBOX<enter>" 
#"run offlineimap to sync inboxes"
macro index O "<shell-escape>offlineimap<enter>" "run offlineimap to sync all mail"
macro index o "<shell-escape>offlineimap -qf INBOX<enter>" "run offlineimap to sync inboxes"
macro index K "<shell-escape>kill -9 $(ps aux|grep offlineimap|grep python|awk ' {print $2} ')<enter>" "kill all offlineimap processes"

macro index U "<limit>all\n" "show all messages (undo limit)"

# notmuch-mutt integration, from `man notmuch-mutt`
macro index L "<enter-command>set my_old_pipe_decode=\$pipe_decode my_old_wait_key=\$wait_key nopipe_decode nowait_key<enter> <shell-escape>notmuch-mutt -r --prompt search<enter><change-folder-readonly>`echo ${XDG_CACHE_HOME:-$HOME/.cache}/notmuch/mutt/results`<enter><enter-command>set pipe_decode=\$my_old_pipe_decode wait_key=\$my_old_wait_key<enter>" "notmuch: search all mail"

macro index <F9> "<enter-command>set my_old_pipe_decode=\$pipe_decode my_old_wait_key=\$wait_key nopipe_decode nowait_key<enter><pipe-message>notmuch-mutt -r thread<enter><change-folder-readonly>`echo ${XDG_CACHE_HOME:-$HOME/.cache}/notmuch/mutt/results`<enter><enter-command>set pipe_decode=\$my_old_pipe_decode wait_key=\$my_old_wait_key<enter>" "notmuch: reconstruct thread"

macro index <F6> "<enter-command>set my_old_pipe_decode=\$pipe_decode my_old_wait_key=\$wait_key nopipe_decode nowait_key<enter><pipe-message>notmuch-mutt tag -- -inbox<enter><enter-command>set pipe_decode=\$my_old_pipe_decode wait_key=\$my_old_wait_key<enter>" "notmuch: remove message from inbox"

# show recipient instead of sender in "Sent" folder view
set date_format='%b %d %k:%M'
set my_index_format_pre='set index_format="%3C %Z %D %-20.20'
set my_index_format_post=' (%4.4c) %?M?<%M> ?%s"'
folder-hook .*[sS]ent.* "$my_index_format_pre"t"$my_index_format_post"
folder-hook ! .*[sS]ent.* "$my_index_format_pre"F"$my_index_format_post"

# mark as spam (S) or ham (H)
macro index,pager S "<enter-command>unset wait_key<enter>\
<pipe-entry>bogofilter -l -s<enter>\
<enter-command>set wait_key<enter>\
<save-message>=riseup/Spam<enter>" "mark as spam"
macro index,pager H "<enter-command>unset wait_key<enter>\
<pipe-entry>bogofilter -l -n<enter>\
<enter-command>set wait_key<enter>\
<save-message>=riseup/INBOX<enter>" "mark as ham (non-spam)"

# Get mutt to display its version on startup.
push <show-version>
